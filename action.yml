description: Build program


inputs:
  token:
    description: Personal Access Token
    required: false
    default: ''

  branch:
    description: platform
    required: false
    default: ''

  arch:
    description: platform
    required: false
    default: 'x64'

  input_file:
    description: platform
    required: false
    default: ''



runs:
  using: composite

  steps:

  - uses: li1ht2ay-3es/gi1-ac2io3s@checkout-branch
    with:
      branch: ${{ inputs.branch }}

      token: ${{ inputs.token }}
      auto: true


  - uses: msys2/setup-msys2@v2
    with:
      update: true
      install: >-
        git
        mingw-w64-x86_64-toolchain
        mingw-w64-x86_64-zlib
        mingw-w64-x86_64-boost
        mingw-w64-x86_64-mpg123
        vim


  - uses: li1ht2ay-3es/cc1ch2-ac3io4@custom
    with:
      key: ${{ inputs.arch }}


  - shell: msys2 {0}
    run: |
      merge () {
        echo "<<< ===  merging  $1  === >>>";
        if [[ -z "$2" ]]; then
          git merge origin/$1 || { git diff --diff-filter=U; exit 1; }
        else
          git merge origin/$1 || { git diff --diff-filter=U; git merge --abort; git merge -X $2 origin/$1; }
        fi
        echo "";
      }



  - if: inputs.arch == 'x86' || inputs.arch == 'x64'
    working-directory: ${{ github.workspace }}
    env:
      CC: ccache ${{ env.MINGW_CC }}
      CXX: ccache ${{ env.MINGW_CXX }}
    shell: msys2 {0}
    run: |
      mingw32-make


  - shell: msys2 {0}
    if: inputs.input_file != ''
    run: |
      ./projectorrays decompile ${{ inputs.input_file }} --dump-scripts --dump-chunks --dump-json
      # ls -a



  - uses: actions/upload-artifact@main
    with:
      path: |
        *.bin
        *.json
        *.ls
        *.lasm
        *.dir
        *.cst
